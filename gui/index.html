<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PvZ3ä¸­å›½ç‰ˆèµ„æºä¸‹è½½å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #a8e6cf 0%, #7fcdcd 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2d5a27;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #4a7c59;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #2d5a27;
            font-weight: 600;
            font-size: 1rem;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 15px;
            border: 2px solid #c8e6c9;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: white;
        }

        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #66bb6a;
        }

        input[type="text"][readonly] {
            cursor: pointer;
            background-color: #f8f9fa;
        }

        input[type="text"][readonly]:hover {
            background-color: #e9ecef;
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #66bb6a;
            cursor: pointer;
        }

        select {
            cursor: pointer;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input-button {
            background: #66bb6a;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            display: inline-block;
            width: 100%;
            text-align: center;
            transition: background-color 0.3s ease;
            border: none;
            font-size: 1rem;
            font-weight: 600;
        }

        .file-input-button:hover {
            background: #5cb85c;
        }

        .file-name {
            margin-top: 10px;
            padding: 10px;
            background: #f1f8e9;
            border-radius: 5px;
            color: #4a7c59;
            display: none;
        }

        .submit-btn {
            background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-top: 20px;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 187, 106, 0.3);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .cancel-btn {
            background: #ef5350;
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
        }

        .cancel-btn:hover {
            background: #e53935;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(239, 83, 80, 0.3);
        }

        .progress-section {
            margin-top: 30px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e8f5e8;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #66bb6a, #4caf50);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .status-text {
            color: #2d5a27;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            background: #f1f8e9;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4caf50;
        }

        .stat-label {
            color: #4a7c59;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .log-section {
            margin-top: 20px;
            display: none;
        }

        .log-container {
            background: #1e2e1e;
            color: #a5d6a7;
            padding: 20px;
            border-radius: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-entry.info {
            color: #81c784;
        }

        .log-entry.error {
            color: #ef5350;
        }

        .log-entry.success {
            color: #66bb6a;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PvZ3ä¸­å›½ç‰ˆèµ„æºä¸‹è½½å™¨</h1>
            <p>Plants vs. Zombies 3 ä¸­å›½ç‰ˆæ¸¸æˆèµ„æºæ‰¹é‡ä¸‹è½½å·¥å…·</p>
        </div>

        <form id="downloadForm">
            <div class="form-group">
                <label for="platform">é€‰æ‹©å¹³å°</label>
                <select id="platform" required>
                    <option value="">è¯·é€‰æ‹©å¹³å°</option>
                    <option value="iOS">ğŸ“± iOS</option>
                    <option value="Android">ğŸ¤– Android</option>
                </select>
            </div>

            <div class="form-group">
                <label for="outputDir">ä¸‹è½½ç›®å½•</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="outputDir" placeholder="è¯·é€‰æ‹©ä¸‹è½½ç›®å½•" readonly style="flex: 1; cursor: pointer;">
                    <button type="button" id="selectDirBtn" class="file-input-button" style="width: auto; padding: 15px 20px; flex-shrink: 0;">
                        ğŸ“ é€‰æ‹©ç›®å½•
                    </button>
                </div>
                <div style="margin-top: 10px; display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="createSubFolder" checked style="width: auto; margin: 0;">
                    <label for="createSubFolder" style="margin: 0; font-weight: normal; color: #4a7c59; cursor: pointer;">
                        åœ¨é€‰æ‹©çš„ç›®å½•ä¸‹åˆ›å»º "pvz3_downloads" æ–‡ä»¶å¤¹
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label for="concurrent">æœ€å¤§å¹¶å‘æ•°</label>
                <input type="number" id="concurrent" value="10" min="1" max="50" required>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">ğŸš€ å¼€å§‹ä¸‹è½½</button>
            <button type="button" class="cancel-btn" id="cancelBtn" style="display: none; margin-top: 15px;">ğŸ›‘ åœæ­¢ä¸‹è½½</button>
        </form>

        <div class="progress-section" id="progressSection">
            <div class="status-text" id="statusText">å‡†å¤‡ä¸‹è½½...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="stats" id="stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalFiles">0</div>
                    <div class="stat-label">æ€»æ–‡ä»¶</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="completedFiles">0</div>
                    <div class="stat-label">å·²å®Œæˆ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="failedFiles">0</div>
                    <div class="stat-label">å¤±è´¥</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="percentage">0%</div>
                    <div class="stat-label">è¿›åº¦</div>
                </div>
            </div>
        </div>

        <div class="log-section" id="logSection">
            <div class="log-container" id="logContainer">
                <div class="log-entry info">ç­‰å¾…å¼€å§‹ä¸‹è½½...</div>
            </div>
        </div>
    </div>

    <script>
        let downloadInProgress = false;
        let logContainer = document.getElementById('logContainer');

        // æ£€æŸ¥æ˜¯å¦åœ¨Electronç¯å¢ƒä¸­
        const isElectron = typeof window.electronAPI !== 'undefined';

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            if (isElectron) {
                initializeElectronListeners();
                loadAppInfo();
                loadUserConfig();
            }
        });

        // åŠ è½½ç”¨æˆ·é…ç½®
        async function loadUserConfig() {
            if (!isElectron) return;
            
            try {
                const userConfig = await window.electronAPI.getUserConfig();
                
                // è®¾ç½®é»˜è®¤å€¼
                if (userConfig.lastDownloadPath) {
                    document.getElementById('outputDir').value = userConfig.lastDownloadPath;
                    document.getElementById('outputDir').placeholder = userConfig.lastDownloadPath;
                }
                
                if (userConfig.lastPlatform) {
                    document.getElementById('platform').value = userConfig.lastPlatform;
                }
                
                if (userConfig.lastConcurrent) {
                    document.getElementById('concurrent').value = userConfig.lastConcurrent;
                }
                
                // è®¾ç½®åˆ›å»ºå­æ–‡ä»¶å¤¹é€‰é¡¹
                if (userConfig.createSubFolder !== undefined) {
                    document.getElementById('createSubFolder').checked = userConfig.createSubFolder;
                } else {
                    document.getElementById('createSubFolder').checked = true; // é»˜è®¤é€‰ä¸­
                }
                
                addLog('å·²åŠ è½½ä¸Šæ¬¡ä½¿ç”¨çš„é…ç½®', 'info');
                
            } catch (error) {
                console.error('Failed to load user config:', error);
                addLog('åŠ è½½é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®', 'info');
            }
        }

        // åˆå§‹åŒ–Electronäº‹ä»¶ç›‘å¬å™¨
        function initializeElectronListeners() {
            // ä¸‹è½½äº‹ä»¶ç›‘å¬
            window.electronAPI.onDownloadStarted((event, data) => {
                addLog(`å¼€å§‹ä¸‹è½½${data.platform.toUpperCase()}å¹³å°èµ„æºåˆ°: ${data.outputDir}`, 'info');
            });

            window.electronAPI.onDownloadCompleted((event, stats) => {
                const message = `ä¸‹è½½å®Œæˆ! æ€»è®¡:${stats.total}, æˆåŠŸ:${stats.success}, å¤±è´¥:${stats.failed}`;
                addLog(message, stats.failed === 0 ? 'success' : 'error');
                onDownloadStopped();
            });

            window.electronAPI.onDownloadStopped((event) => {
                addLog('ä¸‹è½½å·²åœæ­¢', 'info');
                onDownloadStopped();
            });

            window.electronAPI.onDownloadError((event, data) => {
                addLog('ä¸‹è½½é”™è¯¯: ' + data.error, 'error');
                onDownloadStopped();
            });

            window.electronAPI.onProgressUpdate((event, progress) => {
                updateProgress(progress);
            });

            window.electronAPI.onLogMessage((event, data) => {
                addLog(data.message, data.level);
            });

            window.electronAPI.onDirectorySelected((event, dirPath) => {
                document.getElementById('outputDir').value = dirPath;
                addLog('å·²é€‰æ‹©ä¸‹è½½ç›®å½•: ' + dirPath, 'info');
            });
        }

        // åŠ è½½åº”ç”¨ä¿¡æ¯
        async function loadAppInfo() {
            if (isElectron) {
                try {
                    const version = await window.electronAPI.getAppVersion();
                    const systemInfo = window.electronAPI.getSystemInfo();
                    const config = await window.electronAPI.getDownloadConfig();
                    addLog(`PvZ3èµ„æºä¸‹è½½å™¨ v${version} (${systemInfo.platform}-${systemInfo.arch})`, 'info');
                    addLog(`ä¸‹è½½é…ç½®: æœ€å¤§é‡è¯•${config.maxRetries}æ¬¡, è¶…æ—¶${config.timeout/1000}ç§’`, 'info');
                } catch (error) {
                    console.error('Failed to load app info:', error);
                }
            }
        }

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('downloadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (downloadInProgress) {
                return;
            }

            const platform = document.getElementById('platform').value;
            const outputDir = document.getElementById('outputDir').value.trim();
            const concurrent = parseInt(document.getElementById('concurrent').value);
            const createSubFolder = document.getElementById('createSubFolder').checked;

            if (!platform) {
                alert('è¯·é€‰æ‹©ä¸‹è½½å¹³å°');
                return;
            }

            if (!outputDir) {
                alert('è¯·é€‰æ‹©ä¸‹è½½ç›®å½•');
                return;
            }

            // ä¿å­˜ç”¨æˆ·é€‰æ‹©
            if (isElectron) {
                try {
                    await window.electronAPI.saveUserConfig({
                        lastPlatform: platform,
                        lastDownloadPath: outputDir,
                        lastConcurrent: concurrent,
                        createSubFolder: createSubFolder
                    });
                } catch (error) {
                    console.error('Failed to save user config:', error);
                }
            }

            // å¼€å§‹ä¸‹è½½
            if (isElectron) {
                await startDownloadElectron(platform, outputDir, concurrent, createSubFolder);
            } else {
                alert('æ­¤åŠŸèƒ½éœ€è¦åœ¨Electronåº”ç”¨ä¸­è¿è¡Œ');
            }
        });

        // åœæ­¢ä¸‹è½½å¤„ç†
        document.getElementById('cancelBtn').addEventListener('click', async function() {
            if (!downloadInProgress || !isElectron) {
                return;
            }
            
            try {
                const result = await window.electronAPI.stopDownload();
                if (result.success) {
                    addLog('å·²è¯·æ±‚åœæ­¢ä¸‹è½½...', 'info');
                } else {
                    addLog('åœæ­¢ä¸‹è½½å¤±è´¥', 'error');
                }
            } catch (error) {
                addLog('åœæ­¢ä¸‹è½½æ—¶å‘ç”Ÿé”™è¯¯ï¼š' + error.message, 'error');
            }
        });

        // é€‰æ‹©ç›®å½•æŒ‰é’®å¤„ç†
        document.addEventListener('click', function(e) {
            if (e.target.id === 'selectDirBtn') {
                selectDirectory();
            } else if (e.target.id === 'outputDir') {
                // ç‚¹å‡»è¾“å…¥æ¡†ä¹Ÿè§¦å‘ç›®å½•é€‰æ‹©
                selectDirectory();
            }
        });

        // ç›‘å¬å¤é€‰æ¡†å˜åŒ–ï¼Œå®æ—¶ä¿å­˜é…ç½®
        document.addEventListener('change', function(e) {
            if (e.target.id === 'createSubFolder' && isElectron) {
                const createSubFolder = e.target.checked;
                try {
                    window.electronAPI.saveUserConfig({
                        createSubFolder: createSubFolder
                    });
                    addLog(createSubFolder ? 'å°†åœ¨é€‰æ‹©ç›®å½•ä¸‹åˆ›å»º pvz3_downloads æ–‡ä»¶å¤¹' : 'ç›´æ¥ä½¿ç”¨é€‰æ‹©çš„ç›®å½•', 'info');
                } catch (error) {
                    console.error('Failed to save config:', error);
                }
            }
        });

        async function selectDirectory() {
            if (!isElectron) {
                alert('æ­¤åŠŸèƒ½éœ€è¦åœ¨Electronåº”ç”¨ä¸­è¿è¡Œ');
                return;
            }

            try {
                const selectedPath = await window.electronAPI.selectDirectory();
                if (selectedPath) {
                    document.getElementById('outputDir').value = selectedPath;
                    document.getElementById('outputDir').placeholder = selectedPath;
                    addLog('å·²é€‰æ‹©ç›®å½•: ' + selectedPath, 'info');
                    
                    // ä¿å­˜åˆ°ç”¨æˆ·é…ç½®
                    const createSubFolder = document.getElementById('createSubFolder').checked;
                    await window.electronAPI.saveUserConfig({
                        lastDownloadPath: selectedPath,
                        createSubFolder: createSubFolder
                    });
                }
            } catch (error) {
                addLog('é€‰æ‹©ç›®å½•æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            }
        }

        async function startDownloadElectron(platform, outputDir, concurrent, createSubFolder) {
            downloadInProgress = true;
            
            // æ˜¾ç¤ºè¿›åº¦åŒºåŸŸå’Œæ—¥å¿—åŒºåŸŸ
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('logSection').style.display = 'block';
            
            // ç¦ç”¨æäº¤æŒ‰é’®ï¼Œæ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
            const submitBtn = document.getElementById('submitBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'â³ ä¸‹è½½ä¸­...';
            cancelBtn.style.display = 'block';

            // æ¸…ç©ºæ—¥å¿—
            logContainer.innerHTML = '';
            
            try {
                addLog(`æ­£åœ¨å¯åŠ¨${platform.toUpperCase()}å¹³å°ä¸‹è½½ä»»åŠ¡...`, 'info');
                
                const result = await window.electronAPI.startDownload({
                    platform: platform,
                    outputDir: outputDir,
                    concurrent: concurrent,
                    createSubFolder: createSubFolder
                });

                if (result && !result.success) {
                    addLog('å¯åŠ¨ä¸‹è½½å¤±è´¥ï¼š' + result.error, 'error');
                    onDownloadStopped();
                }

            } catch (error) {
                addLog('å‘ç”Ÿé”™è¯¯ï¼š' + error.message, 'error');
                onDownloadStopped();
            }
        }

        function updateProgress(data) {
            const { total, completed, failed, currentFile } = data;
            
            document.getElementById('totalFiles').textContent = total || 0;
            document.getElementById('completedFiles').textContent = completed || 0;
            document.getElementById('failedFiles').textContent = failed || 0;
            
            const percentage = total > 0 ? Math.round((completed + failed) / total * 100) : 0;
            document.getElementById('percentage').textContent = percentage + '%';
            document.getElementById('progressFill').style.width = percentage + '%';
            
            if (currentFile) {
                document.getElementById('statusText').textContent = `æ­£åœ¨ä¸‹è½½: ${currentFile}`;
            }
            
            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
            if (total > 0 && (completed + failed) >= total) {
                document.getElementById('statusText').textContent = failed === 0 ? 'ä¸‹è½½å®Œæˆï¼' : 'ä¸‹è½½å®Œæˆï¼ˆæœ‰é”™è¯¯ï¼‰';
            }
        }

        function addLog(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // åœæ­¢ä¸‹è½½çŠ¶æ€æ›´æ–°
        function onDownloadStopped() {
            downloadInProgress = false;
            const submitBtn = document.getElementById('submitBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            submitBtn.disabled = false;
            submitBtn.textContent = 'ğŸš€ å¼€å§‹ä¸‹è½½';
            cancelBtn.style.display = 'none';
            
            const statusText = document.getElementById('statusText');
            if (!statusText.textContent.includes('å®Œæˆ')) {
                statusText.textContent = 'ä¸‹è½½å·²åœæ­¢';
            }
        }

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error('Global error:', e);
            addLog('åº”ç”¨é”™è¯¯: ' + e.message, 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e);
            addLog('å¼‚æ­¥é”™è¯¯: ' + e.reason, 'error');
        });
    </script>
</body>
</html>